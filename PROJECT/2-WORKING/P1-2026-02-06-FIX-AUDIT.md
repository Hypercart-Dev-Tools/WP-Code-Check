# P1 Fix Audit Plan: Validator Integration + Path-with-Spaces Reliability

**Created:** 2026-02-07  
**Started:** 2026-02-07  
**Updated:** 2026-02-07  
**Status:** In Progress  
**Priority:** Critical  
**Assigned Version:** v2.2.4

## Problem Statement

Two recent fixes are partially implemented and not fully effective in end-to-end scanner execution:

1. `wc-coupon-in-thankyou` context-aware validator is not applied in the primary scan path, so false positives still appear for commented/safe-hook scenarios.
2. `cached_grep` path-with-spaces fix works for multi-file scans but fails when a directory has exactly one PHP file due to cache file path handling.

## Scope

- Fix integration of validated pattern execution for `wc-coupon-in-thankyou`.
- Fix single-file cached path handling in `cached_grep`.
- Add regression tests for both failure modes.
- Update changelog/version metadata for release consistency.

## Non-Goals

- Broad refactor of all legacy hardcoded checks.
- Pattern architecture redesign beyond required wiring for this incident.
- New detection rules unrelated to these two regressions.

## Acceptance Criteria

- [x] Commented-out hook fixture is not flagged by full scanner run.
- [x] Safe checkout hook fixture is not flagged by full scanner run.
- [x] True thank-you hook fixture is flagged by full scanner run.
- [x] Unsanitized superglobal is detected in a path containing spaces with exactly one PHP file.
- [x] Unsanitized superglobal is detected in a path containing spaces with multiple PHP files.
- [x] Existing validator unit tests continue to pass.
- [x] CHANGELOG and scanner version are aligned with delivered fix.

## Implementation Plan

### Phase 1: Validator Integration Repair

- [x] Chosen minimal-risk approach: integrated context-aware validator directly into existing legacy `wc-coupon-in-thankyou` scanner block in `dist/bin/check-performance.sh`.
- [x] Added validator-based suppression handling (exit `1`) and manual-review marking (exit `2`) in main scanner flow.
- [x] Verified false-positive suppression and true-positive retention with full scanner fixture runs.

### Phase 2: cached_grep Single-File Path Fix

- [x] Corrected `cached_grep` single-file handling to scan `PATHS` directly when `--paths` is a file.
- [x] Preserved path-with-spaces safety (`xargs -0`) for cached directory scans (one or more files).
- [x] Verified no regression for single-file directory and multi-file directory scans.

### Phase 3: Regression Test Coverage

- [x] Added scanner-level integration test script: `dist/bin/test-fix-audit-regressions.sh`.
- [x] Added scanner-level regression checks for path-with-spaces scenarios:
  - one PHP file
  - multiple PHP files
- [x] Kept tests lightweight and executable in local/dev CI contexts.

### Phase 4: Release Hygiene

- [x] Updated `CHANGELOG.md` with concrete fixed behaviors and regression coverage.
- [x] Aligned `dist/bin/check-performance.sh` header version and `SCRIPT_VERSION` SOT value to `2.2.4`.
- [x] Updated this project task document status/progress.

## Testing Matrix

- [x] `bash dist/bin/test-wc-coupon-validator.sh`
- [x] Full scanner run on:
  - [x] `dist/bin/fixtures/wc-coupon-thankyou-false-positive-checkout-hook.php`
  - [x] `dist/bin/fixtures/wc-coupon-thankyou-false-positive-commented-hook.php`
  - [x] `dist/bin/fixtures/wc-coupon-thankyou-true-positive.php`
- [x] Full scanner run on temporary path-with-spaces fixtures:
  - [x] one-file unsanitized `$_POST` case
  - [x] multi-file unsanitized `$_POST` case

## Risks and Mitigations

- **Risk:** Changing detection routing may affect other JSON patterns.  
  **Mitigation:** Limit change to existing supported schema path and validate representative scripted patterns.

- **Risk:** Grep helper edits can impact many checks.  
  **Mitigation:** Keep function change minimal and rerun core critical checks in smoke scans.

- **Risk:** Duplicate results from legacy + JSON execution paths.  
  **Mitigation:** Ensure single source of execution for `wc-coupon-in-thankyou` and confirm no double counting.

## Deliverables

- Code fixes in scanner + pattern wiring.
- Regression integration test scripts/fixtures updates.
- Changelog and version alignment updates.
- This document updated to completed state after verification.

## Progress

- [x] Audit completed and root causes verified with reproductions.
- [x] Implementation completed.
- [x] Tests passing.
- [x] Ready for release.

## Next Immediate Step

Move this task document to `PROJECT/3-COMPLETED/` after user sign-off.
