{
  "id": "wp-query-unbounded",
  "version": "2.0.0",
  "enabled": true,
  "category": "performance",
  "severity": "CRITICAL",
  "title": "Unbounded WP_Query/get_posts",
  "description": "Detects WP_Query or get_posts with posts_per_page => -1 or nopaging => true, which can fetch ALL posts and cause memory exhaustion.",
  "rationale": "Loading unlimited posts into memory is a classic WordPress OOM cause. Always use pagination or reasonable limits in production code.",
  "detection": {
    "type": "scripted",
    "file_patterns": ["*.php"],
    "search_pattern": "new[[:space:]]+WP_Query[[:space:]]*\\(|get_posts[[:space:]]*\\(",
    "validator_script": "validators/context-pattern-check.sh",
    "validator_args": ["posts_per_page[[:space:]]*=>[[:space:]]*-1|nopaging[[:space:]]*=>[[:space:]]*true", "10", "after"]
  },
  "mitigation_detection": {
    "enabled": true,
    "validator_script": "validators/mitigation-check.sh",
    "validator_args": ["20"],
    "severity_downgrade": {
      "CRITICAL": "HIGH",
      "HIGH": "MEDIUM",
      "MEDIUM": "LOW"
    }
  },
  "remediation": {
    "summary": "Always specify a reasonable posts_per_page limit for production queries.",
    "examples": [
      {
        "bad": "$query = new WP_Query( array(\n  'post_type' => 'post',\n  'posts_per_page' => -1\n) );",
        "good": "$query = new WP_Query( array(\n  'post_type' => 'post',\n  'posts_per_page' => 100,\n  'no_found_rows' => true\n) );",
        "note": "Use a reasonable limit and disable found_rows for better performance."
      }
    ],
    "references": [
      "https://developer.wordpress.org/reference/classes/wp_query/"
    ]
  },
  "metadata": {
    "tags": ["performance", "wp-query", "unbounded-query", "memory"],
    "added_in_version": "1.0.0",
    "last_updated": "1.3.16"
  }
}
