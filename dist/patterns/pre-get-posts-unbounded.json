{
  "id": "pre-get-posts-unbounded",
  "version": "1.0.0",
  "enabled": true,
  "category": "performance",
  "severity": "CRITICAL",
  "title": "pre_get_posts Hook Sets Unbounded Query",
  "description": "Detects files that hook into pre_get_posts and set posts_per_page => -1 or nopaging => true, which can cause memory exhaustion on sites with many posts.",
  "rationale": "The pre_get_posts hook runs on EVERY query (including admin, REST API, and frontend). Setting unbounded queries here affects the entire site and can cause catastrophic memory failures. Always use conditional logic and reasonable limits.",
  "remediation": "Add conditional checks (is_admin(), is_main_query()) and use reasonable limits instead of -1. Example: if (is_admin() || !$query->is_main_query()) return; $query->set('posts_per_page', 50);",
  "references": [
    "https://developer.wordpress.org/reference/hooks/pre_get_posts/",
    "https://wordpress.stackexchange.com/questions/50761/when-to-use-wp-query-query-posts-and-pre-get-posts"
  ],
  "detection": {
    "type": "scripted",
    "file_patterns": ["*.php"],
    "search_pattern": "add_action.*pre_get_posts|add_filter.*pre_get_posts",
    "validator_script": "validators/pre-get-posts-unbounded-check.sh",
    "validator_args": ["50"],
    "context_lines": 0
  },
  "examples": {
    "bad": [
      "add_action('pre_get_posts', 'my_unbounded_query');\nfunction my_unbounded_query($query) {\n  $query->set('posts_per_page', -1);\n}",
      "add_filter('pre_get_posts', function($query) {\n  $query->set('nopaging', true);\n});"
    ],
    "good": [
      "add_action('pre_get_posts', 'my_bounded_query');\nfunction my_bounded_query($query) {\n  if (is_admin() || !$query->is_main_query()) return;\n  $query->set('posts_per_page', 50);\n}",
      "add_filter('pre_get_posts', function($query) {\n  if (!is_post_type_archive('product')) return;\n  $query->set('posts_per_page', 24);\n});"
    ]
  },
  "metadata": {
    "introduced_in": "1.0.0",
    "last_updated": "1.3.17",
    "author": "WP Code Check",
    "tags": ["performance", "memory", "unbounded-query", "pre_get_posts", "wordpress-hooks"]
  }
}

