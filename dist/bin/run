#!/usr/bin/env bash
#
# Neochrome WP Toolkit - Project Runner
# Simplified command for running checks on configured projects
#
# Usage:
#   run <project-name>           Run checks on a configured project
#   run <project-name> [options] Pass additional options to check-performance.sh
#
# Examples:
#   run acme                     Run checks on 'acme' project
#   run acme --format json       Run checks and output JSON
#   run acme --baseline .baseline Run with baseline suppression

set -euo pipefail

# ============================================================
# Configuration
# ============================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# REPO_ROOT points to dist/ directory (not repository root)
# This ensures templates are loaded from dist/TEMPLATES/ where they belong
# Fixed on 2026-01-05 to match check-performance.sh behavior
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEMPLATES_DIR="$REPO_ROOT/TEMPLATES"
CHECK_SCRIPT="$SCRIPT_DIR/check-performance.sh"
LIB_DIR="$SCRIPT_DIR/lib"

# shellcheck source=dist/bin/lib/colors.sh
source "$LIB_DIR/colors.sh"

# ============================================================
# Helper Functions
# ============================================================

show_usage() {
  echo "Usage: run <project-name> [options]"
  echo ""
  echo "Examples:"
  echo "  run acme                     Run checks on 'acme' project"
  echo "  run acme --format json       Run checks and output JSON"
  echo "  run acme --baseline .baseline Run with baseline suppression"
  echo ""
  echo "Available templates:"
  if [ -d "$TEMPLATES_DIR" ]; then
    for template in "$TEMPLATES_DIR"/*.txt; do
      if [ -f "$template" ] && [[ "$(basename "$template")" != _* ]]; then
        echo "  - $(basename "$template" .txt)"
      fi
    done
  else
    echo "  (none - create templates in $TEMPLATES_DIR)"
  fi
}

# Extract plugin metadata from PHP file
extract_plugin_metadata() {
  local plugin_dir="$1"
  local plugin_name=""
  local plugin_version=""
  
  # Try to find main plugin file (matches directory name)
  local dir_name=$(basename "$plugin_dir")
  local plugin_file="$plugin_dir/${dir_name}.php"
  
  if [ ! -f "$plugin_file" ]; then
    # Fallback: find any PHP file with "Plugin Name:" header
    plugin_file=$(find "$plugin_dir" -maxdepth 1 -name "*.php" -exec grep -l "Plugin Name:" {} \; 2>/dev/null | head -n 1)
  fi
  
  if [ -n "$plugin_file" ] && [ -f "$plugin_file" ]; then
    # Extract Plugin Name (trim leading/trailing whitespace)
    plugin_name=$(grep -i "^\s*\*\s*Plugin Name:" "$plugin_file" | head -n 1 | sed 's/.*Plugin Name:\s*//' | sed 's/\s*$//' | sed 's/\*\///' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

    # Extract Version (trim leading/trailing whitespace)
    plugin_version=$(grep -i "^\s*\*\s*Version:" "$plugin_file" | head -n 1 | sed 's/.*Version:\s*//' | sed 's/\s*$//' | sed 's/\*\///' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')

    echo "${plugin_name}|${plugin_version}"
    return 0
  fi
  
  # Check if it's a theme
  if [ -f "$plugin_dir/style.css" ]; then
    plugin_name=$(grep -i "^Theme Name:" "$plugin_dir/style.css" | head -n 1 | sed 's/.*Theme Name:\s*//' | sed 's/\s*$//')
    plugin_version=$(grep -i "^Version:" "$plugin_dir/style.css" | head -n 1 | sed 's/.*Version:\s*//' | sed 's/\s*$//')
    echo "${plugin_name}|${plugin_version}"
    return 0
  fi
  
  return 1
}

# ============================================================
# Main Logic
# ============================================================

# Check arguments
if [ $# -eq 0 ]; then
  echo -e "${RED}Error: Project name required${NC}"
  echo ""
  show_usage
  exit 1
fi

PROJECT_NAME="$1"
shift  # Remove project name from args

TEMPLATE_FILE="$TEMPLATES_DIR/${PROJECT_NAME}.txt"

# Check if template exists
if [ ! -f "$TEMPLATE_FILE" ]; then
  echo -e "${YELLOW}→ Template '${PROJECT_NAME}' not found.${NC}"
  echo -e "${YELLOW}→ Create from current directory?${NC} [y/N]"
  read -r response
  
  if [[ "$response" =~ ^[Yy]$ ]]; then
    CURRENT_DIR="$(pwd)"
    
    echo -e "${BLUE}→ Attempting to auto-detect plugin metadata...${NC}"
    
    # Try to extract metadata
    if metadata=$(extract_plugin_metadata "$CURRENT_DIR"); then
      IFS='|' read -r PLUGIN_NAME PLUGIN_VERSION <<< "$metadata"
      
      if [ -n "$PLUGIN_NAME" ] && [ -n "$PLUGIN_VERSION" ]; then
        # SUCCESS: Create full template
        cat > "$TEMPLATE_FILE" << 'EOF'
# Neochrome WP Toolkit - Project Configuration
# Auto-generated on DATE_PLACEHOLDER

# ============================================================
# BASIC CONFIGURATION
# ============================================================

# Project identifier (used with 'run' command)
PROJECT_NAME=PROJECT_NAME_PLACEHOLDER

# Project path (REQUIRED)
PROJECT_PATH='PATH_PLACEHOLDER'

# Auto-detected metadata
NAME='NAME_PLACEHOLDER'
VERSION='VERSION_PLACEHOLDER'

# ============================================================
# COMMON OPTIONS
# ============================================================

# Skip specific rules (comma-separated)
# Available rules: nonce-check, sql-injection, n-plus-one, direct-db-query,
#                  unescaped-output, transient-expiration, file-get-contents-url,
#                  http-no-timeout, cron-interval-validation
# Example: SKIP_RULES=nonce-check,n-plus-one
# SKIP_RULES=

# Error/warning thresholds (fail if exceeded)
# MAX_ERRORS=0
# MAX_WARNINGS=10

# ============================================================
# OUTPUT OPTIONS
# ============================================================

# Output format: text, json, html
# FORMAT=text

# ============================================================
# ADVANCED OPTIONS
# (Modify these settings only if you understand their impact)
# ============================================================

# Baseline file for suppressing known issues
# BASELINE=.neochrome-baseline

# Custom log directory
# LOG_DIR=./logs
EOF
        # Replace placeholders
        sed -i.bak "s|DATE_PLACEHOLDER|$(date +%Y-%m-%d)|g" "$TEMPLATE_FILE"
        sed -i.bak "s|PROJECT_NAME_PLACEHOLDER|${PROJECT_NAME}|g" "$TEMPLATE_FILE"
        sed -i.bak "s|PATH_PLACEHOLDER|${CURRENT_DIR}|g" "$TEMPLATE_FILE"
        sed -i.bak "s|NAME_PLACEHOLDER|${PLUGIN_NAME}|g" "$TEMPLATE_FILE"
        sed -i.bak "s|VERSION_PLACEHOLDER|${PLUGIN_VERSION}|g" "$TEMPLATE_FILE"
        rm -f "$TEMPLATE_FILE.bak"

        echo -e "${GREEN}✓ Template created and auto-completed!${NC}"
        echo -e "  ${GREEN}Detected: ${PLUGIN_NAME} v${PLUGIN_VERSION}${NC}"
        echo ""
      else
        # Partial metadata - create template with warning
        cat > "$TEMPLATE_FILE" << EOF
# Neochrome WP Toolkit - Project Configuration
# Auto-generated on $(date +%Y-%m-%d)
# WARNING: Could not fully auto-detect plugin metadata. Please complete manually or ask AI.

# ============================================================
# BASIC CONFIGURATION
# ============================================================

PROJECT_NAME=${PROJECT_NAME}
PROJECT_PATH='${CURRENT_DIR}'
NAME=''
VERSION=''

# ============================================================
# COMMON OPTIONS
# ============================================================

# SKIP_RULES=
# MAX_ERRORS=0
# MAX_WARNINGS=10

# ============================================================
# OUTPUT OPTIONS
# ============================================================

# FORMAT=text

# ============================================================
# ADVANCED OPTIONS
# ============================================================

# BASELINE=.neochrome-baseline
# LOG_DIR=./logs
EOF

        echo -e "${YELLOW}⚠ Template created, but could not fully auto-detect metadata.${NC}"
        echo -e "  ${YELLOW}Please complete the template manually or ask your AI assistant:${NC}"
        echo -e "  ${BLUE}'Complete the template at /TEMPLATES/${PROJECT_NAME}.txt'${NC}"
        echo ""
        exit 1
      fi
    else
      # FALLBACK: Could not detect metadata at all
      cat > "$TEMPLATE_FILE" << EOF
# Neochrome WP Toolkit - Project Configuration
# Created on $(date +%Y-%m-%d)
# WARNING: Could not auto-detect plugin metadata. Please complete manually or ask AI.

# ============================================================
# BASIC CONFIGURATION
# ============================================================

PROJECT_NAME=${PROJECT_NAME}
PROJECT_PATH='${CURRENT_DIR}'
NAME=''
VERSION=''

# ============================================================
# COMMON OPTIONS
# ============================================================

# SKIP_RULES=
# MAX_ERRORS=0
# MAX_WARNINGS=10

# ============================================================
# OUTPUT OPTIONS
# ============================================================

# FORMAT=text

# ============================================================
# ADVANCED OPTIONS
# ============================================================

# BASELINE=.neochrome-baseline
# LOG_DIR=./logs
EOF

      echo -e "${YELLOW}⚠ Template created, but could not auto-detect metadata.${NC}"
      echo -e "  ${YELLOW}Please complete the template manually or ask your AI assistant:${NC}"
      echo -e "  ${BLUE}'Complete the template at /TEMPLATES/${PROJECT_NAME}.txt'${NC}"
      echo ""
      exit 1
    fi
  else
    echo -e "${YELLOW}Cancelled.${NC}"
    exit 1
  fi
fi

# Load template
echo -e "${BLUE}→ Using template: ${PROJECT_NAME}${NC}"

# Source the template to load variables
# shellcheck disable=SC1090
source "$TEMPLATE_FILE"

# Validate required fields
if [ -z "${PROJECT_PATH:-}" ]; then
  echo -e "${RED}Error: PROJECT_PATH not set in template${NC}"
  echo -e "Please edit $TEMPLATE_FILE and set the PROJECT_PATH variable"
  exit 1
fi

if [ ! -d "$PROJECT_PATH" ]; then
  echo -e "${YELLOW}Warning: PROJECT_PATH does not exist: $PROJECT_PATH${NC}"
  echo -e "Please verify the path in $TEMPLATE_FILE"
  exit 1
fi

# Display project info
if [ -n "${NAME:-}" ] && [ -n "${VERSION:-}" ]; then
  echo -e "  ${GREEN}Project: ${NAME} v${VERSION}${NC}"
fi
echo -e "  ${BLUE}Path: ${PROJECT_PATH}${NC}"
echo ""

# Build command arguments
CMD_ARGS=("--paths" "$PROJECT_PATH")

# Add optional arguments from template
if [ -n "${SKIP_RULES:-}" ]; then
  CMD_ARGS+=("--skip-rules" "$SKIP_RULES")
fi

if [ -n "${FORMAT:-}" ]; then
  CMD_ARGS+=("--format" "$FORMAT")
fi

if [ -n "${BASELINE:-}" ]; then
  CMD_ARGS+=("--baseline" "$BASELINE")
fi

# Add user-provided arguments
CMD_ARGS+=("$@")

# Run the check
exec /bin/bash "$CHECK_SCRIPT" "${CMD_ARGS[@]}"
